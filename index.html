<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>LXP-L 批量查询 & 空投估算</title>

<!-- 网站头像 -->
<link rel="icon" href="oq6oo-k8xhm-001.ico">

<!-- dom-to-image 生成分享图 -->
<script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>

<style>
:root{--c-bg:#fafafa;--c-card:#fff;--c-text:#333;--c-sub:#666;
      --c-primary:#28a745;--c-primary-dark:#1e7e34;--c-error:#e11d48;}
body{font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
     background:var(--c-bg);color:var(--c-text);margin:0;padding:32px}
.container{max-width:860px;margin:auto}
.card{background:var(--c-card);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.05);
      padding:28px 32px;margin-bottom:40px;position:relative}
h2{margin:0 0 20px;font-size:24px;display:flex;align-items:center;gap:8px}
h2 .icon{font-size:26px}
textarea{width:100%;height:110px;padding:10px;font-size:14px;border:1px solid #ccc;
        border-radius:6px;resize:vertical;box-sizing:border-box}
button{padding:8px 20px;font-size:15px;border:none;border-radius:6px;cursor:pointer;
       background:var(--c-primary);color:#fff;transition:background .25s}
button:hover{background:var(--c-primary-dark)}
button:disabled{opacity:.6;cursor:not-allowed}
input[type="number"],input[type="text"]{padding:6px 8px;font-size:14px;border:1px solid #ccc;
        border-radius:6px;width:180px}
label{font-size:14px;color:var(--c-sub);display:flex;align-items:center;gap:6px;margin:8px 0}
.badge{position:absolute;top:18px;right:26px;background:#e1e1e1;color:#666;
       padding:2px 8px;font-size:12px;border-radius:12px}
table{width:100%;border-collapse:collapse;margin-top:16px;font-size:14px}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
tbody tr:nth-child(odd){background:#f5f5f5}
.hideRow{display:none}
.error{color:var(--c-error);font-weight:600}
.summary{margin:8px 0 0;font-size:15px}
.summary strong{color:var(--c-primary)}
.fix-est{position:sticky;top:24px;z-index:5}

/* 分享按钮 */
#shareBtn{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border:none;
          border-radius:50%;font-size:14px;font-weight:600;background:var(--c-primary);
          color:#fff;cursor:pointer;display:none;box-shadow:0 4px 10px rgba(0,0,0,.25)}
#shareBtn:hover{background:var(--c-primary-dark)}

@media(prefers-color-scheme:dark){
 :root{--c-bg:#111827;--c-card:#1f2937;--c-text:#e5e7eb;--c-sub:#9ca3af}
 table th,table td{border-color:#374151}
 tbody tr:nth-child(odd){background:#1b2431}
 .badge{background:#374151;color:#a5b4fc}
}
</style>
</head>
<body>

<!-- 分享按钮 -->
<button id="shareBtn">分享</button>

<div class="container" id="captureArea"><!-- 分享截图区域开始 -->

  <!-- ===== 卡片 1：批量查询 ===== -->
  <div class="card" id="queryCard">
    <span class="badge" id="badge">0/0</span>
    <h2><span class="icon">🌱</span>LXP-L 积分查询</h2>

    <textarea id="addrInput" placeholder="每行一个钱包地址"></textarea>
    <button id="queryBtn" style="margin-top:12px">开始查询</button>

    <div id="queryResult"></div>
    <p id="querySummary" class="summary"></p>
    <button id="toggleBtn" style="display:none;background:#0078d4">展开剩余</button>
  </div>

  <!-- ===== 卡片 2：空投估算 ===== -->
  <div class="card fix-est">
    <h2><span class="icon">🍯</span>空投金额估算</h2>

    <label>FDV =
      <input id="fdvInput" type="number" value="1000000000" step="1000000">
      <span id="fdvHint" style="font-size:14px;color:var(--c-sub)"></span>
    </label>

    <label>你的 LXP-L =
      <input id="myXpInput" type="number" placeholder="先查询或手填">
      <span style="font-size:13px;color:var(--c-sub)">≈ <span id="myXpPct">0</span>%</span>
    </label>

    <label>空投百分比 =
      <input id="ratioInput" type="text" value="2,3,5">
    </label>

    <button id="calcBtn">计算</button>
    <div id="calcTableWrap"></div>
  </div>

</div><!-- captureArea 结束 -->

<script>
/* ========= 常量 ========= */
const TOTAL = 130_700_000_000;       // LXP-L 总量
const CON   = 5;                     // 请求并发
const PRE   = 20;                    // 先显示行数

/* ========= FDV 输入提示 ========= */
const fdvI = document.getElementById('fdvInput');
const fdvH = document.getElementById('fdvHint');
fdvI.oninput = ()=>fdvH.textContent = fdvI.value ? `≈ ${(fdvI.value/1e8).toFixed(2)} 亿` : '';
fdvI.oninput();

/* ========= 主要 DOM ========= */
const badge     = document.getElementById('badge');
const queryBtn  = document.getElementById('queryBtn');
const toggleBtn = document.getElementById('toggleBtn');
const shareBtn  = document.getElementById('shareBtn');
const myXpInput = document.getElementById('myXpInput');
const myXpPct   = document.getElementById('myXpPct');
const calcBtn   = document.getElementById('calcBtn');
const calcWrap  = document.getElementById('calcTableWrap');

/* ========= 查询逻辑 ========= */
queryBtn.onclick = async ()=>{
  const addrs=document.getElementById('addrInput').value.trim().split(/\s+/).filter(Boolean);
  if(!addrs.length) return;
  shareBtn.style.display='none';

  badge.textContent=`0/${addrs.length}`;
  const tbody=(()=>{
    document.getElementById('queryResult').innerHTML=
      '<table><thead><tr><th>#</th><th>地址</th><th>LXP-L</th><th>排名</th></tr></thead><tbody></tbody></table>';
    return document.querySelector('#queryResult tbody');
  })();
  document.getElementById('querySummary').textContent='';
  calcWrap.innerHTML=''; toggleBtn.style.display='none';

  let cur=0, done=0, sum=0, hiddenRows=[];
  async function worker(){
    while(cur<addrs.length){
      const i=cur++,addr=addrs[i].toLowerCase();
      let xp=0,rk='-',err=false;
      try{
        const r=await fetch(`/api/points?user=${addr}`); if(!r.ok) throw 0;
        const d=JSON.parse(await r.text()||'{}'); const o=Array.isArray(d)?d[0]:d?.[0]??d;
        xp=+o?.xp||0; rk=o?.rank_xp??'-'; sum+=xp;
      }catch{err=true;}

      const tr=document.createElement('tr');
      if(i>=PRE) tr.className='hideRow';
      tr.innerHTML=`<td>${i+1}</td><td>${addr}</td>
        <td${err?' class="error"':''}>${xp?xp.toLocaleString():'—'}</td>
        <td${err?' class="error"':''}>${rk}</td>`;

      if(i<PRE) tbody.appendChild(tr);           // 前 20 行即时显示
      else      hiddenRows.push(tr);             // 其余暂存

      badge.textContent=`${++done}/${addrs.length}`;
    }
  }
  await Promise.all(Array.from({length:CON},worker));
  // 插入隐藏行
  if(hiddenRows.length) tbody.append(...hiddenRows);

  // 统计 & 自动估算
  document.getElementById('querySummary').innerHTML=
    `<strong>地址：</strong>${addrs.length}　|　<strong>LXP-L：</strong>${sum.toLocaleString()}`;
  myXpInput.value=sum||''; myXpPct.textContent=((sum/TOTAL)*100).toFixed(2);
  autoCalc();

  // 展开/收起按钮
  if(hiddenRows.length){
    toggleBtn.textContent=`展开剩余 ${hiddenRows.length} 行`;
    toggleBtn.style.display='inline-block';
  }
  // 显示分享按钮
  shareBtn.style.display='block';
};

toggleBtn.onclick=()=>{
  const hidden=document.querySelectorAll('.hideRow');
  const expand=toggleBtn.textContent.startsWith('展开');
  hidden.forEach(row=>row.style.display=expand?'table-row':'none');
  toggleBtn.textContent=expand?'收起':`展开剩余 ${hidden.length} 行`;
};

/* ========= 估算 ========= */
function autoCalc(){ calcBtn.click(); }
calcBtn.onclick=()=>{
  const xp=+myXpInput.value||0, fdv=+fdvI.value||0,
        rates=document.getElementById('ratioInput').value.split(',').map(s=>+s/100).filter(n=>n>0);
  if(!xp||!fdv||!rates.length) return;
  const price=fdv/TOTAL;
  calcWrap.innerHTML=`<table><thead><tr><th>空投百分比</th><th>空投金额 (万元)</th>
    <th>每 LXP-L 价格 (USD)</th><th>你的空投价值 (USD)</th></tr></thead><tbody>
    ${rates.map(r=>{
      const pool=fdv*r/1e4, usd=xp*r*price;
      return `<tr><td>${(r*100).toFixed(2)}%</td>
        <td>${pool.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>${price.toFixed(6)}</td><td>${usd.toFixed(2)}</td></tr>`;}).join('')}
  </tbody></table>`;
};

/* ========= 分享图 ========= */
shareBtn.onclick=()=>{
  shareBtn.disabled=true; shareBtn.textContent='生成中…';
  domtoimage.toPng(document.getElementById('captureArea'),{pixelRatio:2})
    .then(url=>{
      const a=document.createElement('a'); a.href=url; a.download='lxp-l_snapshot.png'; a.click();
      shareBtn.disabled=false; shareBtn.textContent='分享';
    })
    .catch(e=>{alert('生成失败');console.error(e);
      shareBtn.disabled=false; shareBtn.textContent='分享';});
};
</script>
</body>
</html>
