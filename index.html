<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>LXP-L æ‰¹é‡æŸ¥è¯¢ & ç©ºæŠ•ä¼°ç®—</title>

  <!-- ç½‘ç«™å¤´åƒ -->
  <link rel="icon" href="oq6oo-k8xhm-001.ico">

  <!-- dom-to-imageï¼šç”Ÿæˆåˆ†äº«å›¾ -->
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>

  <style>
    :root{
      --c-bg:#fafafa; --c-card:#fff; --c-text:#333; --c-sub:#666;
      --c-primary:#28a745; --c-primary-dark:#1e7e34; --c-error:#e11d48;
    }
    body{font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
         background:var(--c-bg);color:var(--c-text);margin:0;padding:32px}
    .container{max-width:860px;margin:auto}
    .card{background:var(--c-card);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.05);
          padding:28px 32px;margin-bottom:40px;position:relative}
    h2{margin:0 0 20px;font-size:24px;display:flex;align-items:center;gap:8px}
    h2 .icon{font-size:26px}
    textarea{width:100%;height:110px;padding:10px;font-size:14px;border:1px solid #ccc;
            border-radius:6px;resize:vertical;box-sizing:border-box}
    button{padding:8px 20px;font-size:15px;border:none;border-radius:6px;cursor:pointer;
           background:var(--c-primary);color:#fff;transition:background .25s}
    button:hover{background:var(--c-primary-dark)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input[type="number"],input[type="text"]{padding:6px 8px;font-size:14px;border:1px solid #ccc;
            border-radius:6px;width:180px}
    label{font-size:14px;color:var(--c-sub);display:flex;align-items:center;gap:6px;margin:8px 0}
    .badge{position:absolute;top:18px;right:26px;background:#e1e1e1;color:#666;
           padding:2px 8px;font-size:12px;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:16px;font-size:14px}
    th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
    tbody tr:nth-child(odd){background:#f5f5f5}
    .hideRow{display:none}
    .loading{color:var(--c-sub)}
    .error{color:var(--c-error);font-weight:600}
    .summary{margin:8px 0 0;font-size:15px}
    .summary strong{color:var(--c-primary)}
    .fix-est{position:sticky;top:24px;z-index:5}

    /* åˆ†äº«æŒ‰é’® */
    #shareBtn{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border:none;
              border-radius:50%;font-size:14px;font-weight:600;background:var(--c-primary);
              color:#fff;cursor:pointer;display:none;box-shadow:0 4px 10px rgba(0,0,0,.25)}
    #shareBtn:hover{background:var(--c-primary-dark)}

    @media(prefers-color-scheme:dark){
      :root{--c-bg:#111827;--c-card:#1f2937;--c-text:#e5e7eb;--c-sub:#9ca3af}
      table th,table td{border-color:#374151}
      tbody tr:nth-child(odd){background:#1b2431}
      .badge{background:#374151;color:#a5b4fc}
    }
  </style>
</head>
<body>

<!-- åˆ†äº«æŒ‰é’® -->
<button id="shareBtn">åˆ†äº«</button>

<div class="container" id="captureArea">

  <!-- ===== æŸ¥è¯¢å¡ç‰‡ ===== -->
  <div class="card">
    <span class="badge" id="badge">0/0</span>
    <h2><span class="icon">ğŸŒ±</span>LXP-L ç§¯åˆ†æŸ¥è¯¢</h2>

    <textarea id="addrInput" placeholder="æ¯è¡Œä¸€ä¸ªé’±åŒ…åœ°å€"></textarea>
    <button id="queryBtn" style="margin-top:12px">å¼€å§‹æŸ¥è¯¢</button>

    <div id="queryResult"></div>
    <p id="querySummary" class="summary"></p>
    <button id="toggleBtn" style="display:none;background:#0078d4">å±•å¼€å‰©ä½™</button>
  </div>

  <!-- ===== ä¼°ç®—å¡ç‰‡ ===== -->
  <div class="card fix-est">
    <h2><span class="icon">ğŸ¯</span>ç©ºæŠ•é‡‘é¢ä¼°ç®—</h2>

    <!-- LXP-L æ€»é‡æç¤º -->
    <p style="margin:-10px 0 10px;font-size:14px;color:var(--c-sub)">
      LXP-L æ€»é‡ï¼š<strong>130,700,000,000</strong>
    </p>

    <label>FDV =
      <input id="fdvInput" type="number" value="1000000000" step="1000000">
      <span id="fdvHint" style="font-size:14px;color:var(--c-sub)"></span>
    </label>

    <label>ä½ çš„ LXP-L =
      <input id="myXpInput" type="number" placeholder="å…ˆæŸ¥è¯¢æˆ–æ‰‹å¡«">
      <span style="font-size:13px;color:var(--c-sub)">â‰ˆ <span id="myXpPct">0</span>%</span>
    </label>

    <label>ç©ºæŠ•ç™¾åˆ†æ¯” =
      <input id="ratioInput" type="text" value="2,3,5">
    </label>

    <button id="calcBtn">è®¡ç®—</button>
    <div id="calcTableWrap"></div>
  </div>

</div>

<script>
/* ---- å¸¸é‡ ---- */
const TOTAL = 130_700_000_000;      // LXP-L æ€»é‡
const CON   = 5;                    // å¹¶å‘
const PRE   = 20;                   // ç«‹å³å±•ç¤ºè¡Œæ•°

/* ---- FDV æç¤º ---- */
const fdvI=document.getElementById('fdvInput');
const fdvH=document.getElementById('fdvHint');
fdvI.oninput=()=>fdvH.textContent=fdvI.value ? `â‰ˆ ${(fdvI.value/1e8).toFixed(2)} äº¿` : '';
fdvI.oninput();

/* ---- ç»‘å®š DOM ---- */
const badge=document.getElementById('badge');
const queryBtn=document.getElementById('queryBtn');
const toggleBtn=document.getElementById('toggleBtn');
const shareBtn=document.getElementById('shareBtn');
const myXpInput=document.getElementById('myXpInput');
const myXpPct=document.getElementById('myXpPct');
const calcBtn=document.getElementById('calcBtn');
const calcWrap=document.getElementById('calcTableWrap');

/* ---- æ‰¹é‡æŸ¥è¯¢ ---- */
queryBtn.onclick=async()=>{
  const addrs=document.getElementById('addrInput').value.trim().split(/\s+/).filter(Boolean);
  if(!addrs.length) return;
  badge.textContent=`0/${addrs.length}`; shareBtn.style.display='none';

  /* ç”Ÿæˆè¡¨æ ¼ä¸å ä½è¡Œ */
  const tbody=(()=>{document.getElementById('queryResult').innerHTML=
    '<table><thead><tr><th>#</th><th>åœ°å€</th><th>LXP-L</th><th>æ’å</th></tr></thead><tbody></tbody></table>';
    return document.querySelector('#queryResult tbody');})();
  const rowMap={};
  addrs.forEach((a,i)=>{
    const tr=document.createElement('tr');
    if(i>=PRE) tr.className='hideRow';
    tr.innerHTML=`<td>${i+1}</td><td>${a.toLowerCase()}</td>
                 <td class="loading">åŠ è½½ä¸­</td><td class="loading">åŠ è½½ä¸­</td>`;
    tbody.appendChild(tr); rowMap[a.toLowerCase()]=tr;
  });

  /* å±•å¼€æŒ‰é’®ç«‹å³å¯è§ */
  if(addrs.length>PRE){
    toggleBtn.textContent=`å±•å¼€å‰©ä½™ ${addrs.length-PRE} è¡Œ`;
    toggleBtn.style.display='inline-block';
  }else toggleBtn.style.display='none';

  /* å¹¶å‘è¯·æ±‚ */
  let cur=0,done=0,sum=0;
  async function worker(){
    while(cur<addrs.length){
      const i=cur++,addr=addrs[i].toLowerCase();
      let xp=0,rk='-',err=false;
      try{
        const r=await fetch(`/api/points?user=${addr}`); if(!r.ok) throw 0;
        const d=JSON.parse(await r.text()||'{}'); const o=Array.isArray(d)?d[0]:d?.[0]??d;
        xp=+o?.xp||0; rk=o?.rank_xp??'-'; sum+=xp;
      }catch{err=true;}
      const td=rowMap[addr].children;
      td[2].textContent=xp?xp.toLocaleString():'â€”';
      td[3].textContent=rk;
      td[2].className=td[3].className=err?'error':'';
      badge.textContent=`${++done}/${addrs.length}`;
    }
  }
  await Promise.all(Array.from({length:CON},worker));

  /* æ±‡æ€» & ä¼°ç®— */
  document.getElementById('querySummary').innerHTML=
    `<strong>åœ°å€ï¼š</strong>${addrs.length}ã€€|ã€€<strong>LXP-Lï¼š</strong>${sum.toLocaleString()}`;
  myXpInput.value=sum; myXpPct.textContent=((sum/TOTAL)*100).toFixed(2);
  autoCalc(); shareBtn.style.display='block';
};

/* å±•å¼€ / æ”¶èµ· */
toggleBtn.onclick=()=>{
  const rows=document.querySelectorAll('.hideRow');
  const exp=toggleBtn.textContent.startsWith('å±•å¼€');
  rows.forEach(r=>r.style.display=exp?'table-row':'none');
  toggleBtn.textContent=exp?'æ”¶èµ·':`å±•å¼€å‰©ä½™ ${rows.length} è¡Œ`;
};

/* ---- ä¼°ç®— ---- */
function autoCalc(){ calcBtn.click(); }
calcBtn.onclick=()=>{
  const xp=+myXpInput.value||0, fdv=+fdvI.value||0,
        rates=document.getElementById('ratioInput').value.split(',')
              .map(s=>+s/100).filter(n=>n>0);
  if(!xp||!fdv||!rates.length)return;
  const price=fdv/TOTAL;
  calcWrap.innerHTML=`<table><thead><tr><th>ç©ºæŠ•ç™¾åˆ†æ¯”</th><th>ç©ºæŠ•é‡‘é¢ (ä¸‡å…ƒ)</th>
    <th>æ¯ LXP-L ä»·æ ¼ (USD)</th><th>ä½ çš„ç©ºæŠ•ä»·å€¼ (USD)</th></tr></thead><tbody>
    ${rates.map(r=>`<tr><td>${(r*100).toFixed(2)}%</td>
      <td>${(fdv*r/1e4).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td>${price.toFixed(6)}</td>
      <td>${(xp*r*price).toFixed(2)}</td></tr>`).join('')}
  </tbody></table>`;
};

/* ---- åˆ†äº«ï¼šæ–°æ ‡ç­¾é¡µæ˜¾ç¤ºå›¾ç‰‡ ---- */
shareBtn.onclick=()=>{
  shareBtn.disabled=true; shareBtn.textContent='ç”Ÿæˆâ€¦';
  domtoimage.toPng(document.getElementById('captureArea'),{pixelRatio:2})
    .then(url=>{window.open(url,'_blank');
      shareBtn.disabled=false; shareBtn.textContent='åˆ†äº«';})
    .catch(e=>{alert('ç”Ÿæˆå¤±è´¥'); console.error(e);
      shareBtn.disabled=false; shareBtn.textContent='åˆ†äº«';});
};
</script>
</body>
</html>
